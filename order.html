<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Food Delivery Website</title>
    <!-- Favicon -->
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
    <!-- Fontawesome CSS -->
    <link rel="stylesheet" href="css/font-awesome/css/font-awesome.css">
    <!-- Hover CSS -->
    <link rel="stylesheet" href="css/hover-min.css">
    <!--Map-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="live-map.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="cart.js" defer></script>
    <script src="custom.js"></script>
    <style>
        header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 15px 30px;
          background-color: #fff;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        header .logo {
          font-size: 24px;
          font-weight: bold;
          color: #ff3e3e;
        }
        header .cart-icon {
          position: relative;
          font-size: 20px;
          color: #333;
        }
        header .cart-icon span {
          position: absolute;
          top: -10px;
          right: -10px;
          background-color: #ff3e3e;
          color: #fff;
          border-radius: 50%;
          padding: 2px 6px;
          font-size: 12px;
        }
        .container {
          max-width: 900px;
          margin: 60px auto;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h2, h3 {
          text-align: center;
          margin-bottom: 20px;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 20px;
        }
        th, td {
          padding: 12px;
          border: 1px solid #ddd;
          text-align: center;
        }
        form {
          display: flex;
          flex-direction: column;
          gap: 15px;
        }
        input {
          padding: 12px;
          border: 1px solid #ddd;
          border-radius: 6px;
          font-size: 16px;
        }
        button {
          background-color: #ff3e3e;
          color: white;
          padding: 12px;
          border: none;
          border-radius: 6px;
          font-size: 16px;
          cursor: pointer;
          transition: background-color 0.3s ease;
        }
        button:hover {
          background-color: #e03131;
        }
      </style>
      <!-- Add styles for delivery schedule UI -->
      <style>
        .delivery-schedule {
          background-color: #f9f9f9;
          border-radius: 8px;
          padding: 20px;
          margin: 15px 0;
          box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .delivery-schedule h3 {
          margin-top: 0;
          color: #333;
          font-size: 18px;
          text-align: left;
        }
        
        .delivery-options {
          display: flex;
          gap: 15px;
          margin-bottom: 20px;
        }
        
        .option-card {
          flex: 1;
          background: white;
          border: 2px solid #eee;
          border-radius: 10px;
          padding: 15px;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s ease;
        }
        
        .option-card:hover {
          transform: translateY(-3px);
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .option-card.active {
          border-color: #ff3b3b;
          background-color: #fff8f8;
        }
        
        .option-icon {
          font-size: 28px;
          margin-bottom: 8px;
        }
        
        .option-label {
          font-weight: bold;
          color: #333;
        }
        
        .date-time-picker {
          display: flex;
          gap: 15px;
          margin-top: 15px;
        }
        
        .date-picker, .time-picker {
          flex: 1;
        }
        
        .date-time-picker label {
          display: block;
          margin-bottom: 8px;
          font-weight: bold;
          color: #555;
        }
        
        .date-time-picker input,
        .date-time-picker select {
          width: 100%;
          padding: 12px;
          border: 1px solid #ddd;
          border-radius: 6px;
          font-size: 16px;
          background-color: white;
        }
        
        @media (max-width: 768px) {
          .date-time-picker {
            flex-direction: column;
          }
        }
      </style>
</head>
<body>
    <!-- Navigation Section Start -->
    <header class="navbar">
        <nav id="site-top-nav" class="navbar-menu navbar-fixed-top">
            <div class="container">
                <!-- logo -->
                <div class="logo">
                    <a href="index.html" title="Logo">
                        <img src="../assets/img/logo.png" alt="Logo" class="logo">
                    </a>
                </div>
                <!-- Main Menu -->
                <div class="menu text-right">
                    <ul>
                        <li><a class="hvr-underline-from-center" href="index.html">Home</a></li>
                        <li><a class="hvr-underline-from-center" href="categories.html">Categories</a></li>
                        <li><a class="hvr-underline-from-center" href="foods.html">Foods</a></li>
                        <li><a class="hvr-underline-from-center" href="order.html">Order</a></li>
                        <li><a class="hvr-underline-from-center" href="contact.html">Contact</a></li>
                        <li><a class="hvr-underline-from-center" href="login.html">Login</a></li>
                        <li><a class="hvr-underline-from-center" href="profile.html"><i class="fas fa-user-circle"></i> My Account</a></li>
                        <li class="cart">
                          <a href="order.html" class="cart-icon">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="cart-count">0</span>
                          </a>
                      </li>
                            <div id="cart-content" class="cart-content">
                                <h3 class="text-center">Shopping Cart</h3>
                                <table class="cart-table" border="0">
                                    <tr>
                                        <th>Food</th>
                                        <th>Name</th>
                                        <th>Price</th>
                                        <th>Qty</th>
                                        <th>Total</th>
                                        <th>Action</th>
                                    </tr>
                                    <tr>
                                        <td><img src="../assets/img/p1.jpg" alt="Food"></td>
                                        <td>Pizza</td>
                                        <td>$ 8.00</td>
                                        <td>1</td>
                                        <td>$ 8.00</td>
                                        <td><a href="#" class="btn-delete">&times;</a></td>
                                    </tr>
                                    <tr>
                                        <td><img src="../assets/img/s1.jpg" alt="Food"></td>
                                        <td>Sandwich</td>
                                        <td>$ 8.00</td>
                                        <td>1</td>
                                        <td>$ 8.00</td>
                                        <td><a href="#" class="btn-delete">&times;</a></td>
                                    </tr>
                                    <tr>
                                        <td><img src="../assets/img/b1.jpg" alt="Food"></td>
                                        <td>Burder</td>
                                        <td>$ 8.00</td>
                                        <td>1</td>
                                        <td>$ 8.00</td>
                                        <td><a href="#" class="btn-delete">&times;</a></td>
                                    </tr>
                                    <tr>
                                        <th colspan="4">Total</th>
                                        <th>$24.00$</th>
                                        <th></th>
                                    </tr>
                                </table>
                                <a href="order.html" class="btn-primary">Confirm Order</a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>
    <!-- Navigation Section End -->

    <!-- Food Order Section Start -->
    <section class="container">
        <h2>Fill this form to confirm your order.</h2>
        <table>
          <thead>
            <tr>
              <th>S.N.</th>
              <th>Food</th>
              <th>Name</th>
              <th>Price</th>
              <th>Qty</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="cart-table"></tbody>
        </table>
        <h3>Total: <span id="total-amount">$0</span></h3>
    
        <form onsubmit="return confirmOrder(event)">
          <input type="text" placeholder="Enter your name..." required>
          <input type="text" placeholder="Enter your phone..." required>
          <input type="email" placeholder="Enter your email..." required>
          <input type="text" placeholder="Enter your address..." required>
          
          <div class="delivery-schedule">
            <h3>Delivery Options</h3>
            <div class="delivery-options">
              <div class="option-card active" onclick="selectDeliveryOption('asap')">
                <div class="option-icon">🚀</div>
                <div class="option-label">ASAP</div>
              </div>
              <div class="option-card" onclick="selectDeliveryOption('scheduled')">
                <div class="option-icon">⏰</div>
                <div class="option-label">Schedule</div>
              </div>
            </div>
            
            <div id="schedule-controls" style="display:none;">
              <div class="date-time-picker">
                <div class="date-picker">
                  <label for="delivery-date">Delivery Date</label>
                  <input type="date" id="delivery-date" min="">
                </div>
                <div class="time-picker">
                  <label for="delivery-time">Delivery Time</label>
                  <select id="delivery-time">
                    <option value="">Select time</option>
                    <option value="10:00">10:00 AM</option>
                    <option value="10:30">10:30 AM</option>
                    <option value="11:00">11:00 AM</option>
                    <option value="11:30">11:30 AM</option>
                    <option value="12:00">12:00 PM</option>
                    <option value="12:30">12:30 PM</option>
                    <option value="13:00">1:00 PM</option>
                    <option value="13:30">1:30 PM</option>
                    <option value="14:00">2:00 PM</option>
                    <option value="14:30">2:30 PM</option>
                    <option value="15:00">3:00 PM</option>
                    <option value="15:30">3:30 PM</option>
                    <option value="16:00">4:00 PM</option>
                    <option value="16:30">4:30 PM</option>
                    <option value="17:00">5:00 PM</option>
                    <option value="17:30">5:30 PM</option>
                    <option value="18:00">6:00 PM</option>
                    <option value="18:30">6:30 PM</option>
                    <option value="19:00">7:00 PM</option>
                    <option value="19:30">7:30 PM</option>
                    <option value="20:00">8:00 PM</option>
                    <option value="20:30">8:30 PM</option>
                    <option value="21:00">9:00 PM</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          <button type="submit">Confirm Order</button>
        </form>
      </section>
    
      <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://apexmqhfzzsykjwanjfx.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwZXhtcWhmenpzeWtqd2FuamZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NzUwNzEsImV4cCI6MjA2MjA1MTA3MX0.C5FIERevPeBTEkFdsysc4jZJ7R7hGfmQbf7aiHoqO-c';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        let total = 0;
        let deliveryOption = "asap";
        let scheduledTime = null;
        let currentUser = null;
    
        const tableBody = document.getElementById("cart-table");
    
        cart.forEach((item, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td><img src="assets/img/${item.name.toLowerCase()}.jpg" alt="${item.name}" style="width: 50px"></td>
            <td>${item.name}</td>
            <td>$${item.price.toFixed(2)}</td>
            <td>${item.qty}</td>
            <td>$${item.total.toFixed(2)}</td>
            <td><button onclick="removeItem(${index})">&times;</button></td>
          `;
          total += item.total;
          tableBody.appendChild(row);
        });
    
        document.getElementById("total-amount").textContent = `$${total.toFixed(2)}`;
    
        function removeItem(index) {
          cart.splice(index, 1);
          localStorage.setItem("cart", JSON.stringify(cart));
          location.reload();
        }
    
        async function confirmOrder(event) {
          event.preventDefault();
          
          // Check if user is logged in
          const { data: { user } } = await supabase.auth.getUser();
          
          if (!user) {
            // Save the current URL to redirect back after login
            localStorage.setItem('redirectAfterLogin', window.location.href);
            
            // Redirect to login page
            window.location.href = 'login.html';
            return false;
          }
          
          // Get form values
          const name = event.target.querySelector('input[placeholder="Enter your name..."]').value;
          const phone = event.target.querySelector('input[placeholder="Enter your phone..."]').value;
          const email = event.target.querySelector('input[placeholder="Enter your email..."]').value;
          const address = event.target.querySelector('input[placeholder="Enter your address..."]').value;
          
          // Save delivery schedule information
          if (deliveryOption === "scheduled" && scheduledTime) {
            localStorage.setItem("scheduledDelivery", JSON.stringify(scheduledTime));
          } else {
            localStorage.removeItem("scheduledDelivery");
          }
          
          try {
            // Create order in the database
            const { data: order, error: orderError } = await supabase
              .from('orders')
              .insert([
                {
                  user_id: user.id,
                  total_amount: total,
                  status: 'Pending',
                  delivery_address: address,
                  customer_name: name,
                  customer_phone: phone,
                  customer_email: email,
                  delivery_option: deliveryOption,
                  scheduled_time: scheduledTime ? scheduledTime.formatted : null,
                  created_at: new Date().toISOString()
                }
              ])
              .select();
              
            if (orderError) throw orderError;
            
            // Create order items
            const orderItems = cart.map(item => ({
              order_id: order[0].id,
              product_name: item.name,
              price: item.price,
              quantity: item.qty,
              total: item.total
            }));
            
            const { error: itemsError } = await supabase
              .from('order_items')
              .insert(orderItems);
              
            if (itemsError) throw itemsError;
            
            // Clear the cart
            localStorage.removeItem("cart");
            
            // Continue to payment page
            window.location.href = `payment.html?total=${total.toFixed(2)}&order_id=${order[0].id}`;
          } catch (error) {
            console.error('Error creating order:', error);
            alert('There was an error processing your order. Please try again.');
          }
          
          return false;
        }
    
        function updateCartCount() {
          const cart = JSON.parse(localStorage.getItem("cart")) || [];
          const count = cart.reduce((acc, item) => acc + item.qty, 0);
          const cartCount = document.getElementById("cart-count");
          if (cartCount) cartCount.textContent = count;
        }
        
        function selectDeliveryOption(option) {
          deliveryOption = option;
          
          // Update UI
          document.querySelectorAll('.option-card').forEach(card => {
            card.classList.remove('active');
          });
          
          const selectedCard = document.querySelector(`.option-card[onclick*="${option}"]`);
          if (selectedCard) selectedCard.classList.add('active');
          
          // Show/hide schedule controls
          const scheduleControls = document.getElementById('schedule-controls');
          if (option === 'scheduled') {
            scheduleControls.style.display = 'block';
            setupDateTimePicker();
          } else {
            scheduleControls.style.display = 'none';
            scheduledTime = null;
          }
        }
        
        function setupDateTimePicker() {
          // Set min date to today
          const today = new Date();
          const dateInput = document.getElementById('delivery-date');
          
          // Format date as YYYY-MM-DD for the input
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          
          dateInput.min = `${year}-${month}-${day}`;
          dateInput.value = `${year}-${month}-${day}`;
          
          // Add event listeners
          dateInput.addEventListener('change', updateScheduledTime);
          document.getElementById('delivery-time').addEventListener('change', updateScheduledTime);
          
          // Initialize with current selected values
          updateScheduledTime();
        }
        
        function updateScheduledTime() {
          const dateInput = document.getElementById('delivery-date');
          const timeInput = document.getElementById('delivery-time');
          
          if (dateInput.value && timeInput.value) {
            scheduledTime = {
              date: dateInput.value,
              time: timeInput.value,
              formatted: formatScheduledTime(dateInput.value, timeInput.value)
            };
          } else {
            scheduledTime = null;
          }
        }
        
        function formatScheduledTime(dateStr, timeStr) {
          const date = new Date(dateStr + 'T' + timeStr);
          const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          };
          
          return date.toLocaleDateString('en-US', options);
        }
    
        updateCartCount();
        
        // Initialize date time picker if we're on a previously scheduled order
        const savedSchedule = JSON.parse(localStorage.getItem("scheduledDelivery"));
        if (savedSchedule) {
          selectDeliveryOption('scheduled');
          document.getElementById('delivery-date').value = savedSchedule.date;
          document.getElementById('delivery-time').value = savedSchedule.time;
          updateScheduledTime();
        }
        
        // Check authentication status on page load
        async function checkAuth() {
          const { data: { user } } = await supabase.auth.getUser();
          currentUser = user;
          
          // Pre-fill user information if available
          if (user) {
            try {
              const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();
                
              if (profile) {
                // Pre-fill form with user data
                const nameInput = document.querySelector('input[placeholder="Enter your name..."]');
                const phoneInput = document.querySelector('input[placeholder="Enter your phone..."]');
                const emailInput = document.querySelector('input[placeholder="Enter your email..."]');
                const addressInput = document.querySelector('input[placeholder="Enter your address..."]');
                
                if (nameInput) nameInput.value = profile.full_name || '';
                if (phoneInput) phoneInput.value = profile.phone || '';
                if (emailInput) emailInput.value = profile.email || user.email || '';
                if (addressInput) addressInput.value = profile.address_line_1 ? 
                  `${profile.address_line_1}, ${profile.city}, ${profile.postal_code}` : '';
              }
            } catch (error) {
              console.error('Error fetching profile:', error);
            }
          }
        }
        
        // Check authentication
        checkAuth();
      </script>
    <!-- Food Order Section End -->

    <!-- Footer Section Start -->
    <section class="footer">
        <div class="container">
            <div class="grid-3">
                <div class="text-center">
                    <h3>About Us</h3><br>
                    <p>Fresh, fast, and at your doorstep! 🚀 Our food delivery app connects you with your favorite restaurants, bringing delicious meals right to you—hot, fresh, and hassle-free. Order now and taste the convenience! 🍽️🔥</p>
                </div>
                <div class="texr-center">
                    <h3>Site Map</h3><br>
                    <div class="site-links">
                        <a href="categories.html">Categories</a>
                        <a href="foods.html">Foods</a>
                        <a href="order.html">Order</a>
                        <a href="contact.html">Contact</a>
                        <a href="login.html">Login</a>
                    </div>
                </div>
                <div class="social-links">
                    <h3>Social Links</h3><br>
                    <div class="social">
                        <ul>
                            <li><a href="#"><img src="https://img.icons8.com/color/48/null/facebook-new.png"/></a></li>
                            <li><a href="#"><img src="https://img.icons8.com/fluency/48/null/instagram-new.png"/></a></li>
                            <li><a href="#"><img src="https://img.icons8.com/color/48/null/twitter--v1.png"/></a></li>
                            <li><a href="#"><img src="https://img.icons8.com/color/48/null/linkedin-circled--v1.png"/></a></li>
                            <li><a href="#"><img src="https://img.icons8.com/color/48/null/youtube-play.png"/></a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Footer Section End -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="live-map.js"></script>
    
    <!-- Map popup -->
    <div class="map-popup">
        <button class="close-btn" onclick="closeMap()">×</button>
        <div id="map"></div>
        <div id="eta-info">Estimated delivery time: <span id="eta-time">15-20 min</span></div>
    </div>

    <button class="open-map-btn" onclick="openMap()">Live Map 🚗</button>
  </body>
</html>